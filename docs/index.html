<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>楊大師八字命盤生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.3/lunar.min.js"></script>
    <style>
        .bazi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .bazi-cell {
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
        }
        .ten-gods {
            font-size: 0.75rem;
            color: #718096;
        }
        .hidden {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .element-bar {
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2px;
        }
        .wood { color: #4CAF50; }
        .fire { color: #F44336; }
        .earth { color: #FFC107; }
        .metal { color: #9E9E9E; }
        .water { color: #2196F3; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <h1 class="text-3xl font-bold text-center text-red-600 mb-6">楊大師八字命盤生成器</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">輸入出生資訊</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="輸入姓名">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">曆法</label>
                    <select id="calendarType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="solar">西曆</option>
                        <option value="lunar">農曆</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">出生日期</label>
                    <input type="date" id="birthDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">出生時間</label>
                    <input type="time" id="birthTime" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="12:00">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">性別</label>
                    <select id="gender" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="male">男</option>
                        <option value="female">女</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">出生地點</label>
                    <select id="location" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="國內">國內</option>
                        <option value="台灣">台灣</option>
                        <option value="香港">香港</option>
                        <option value="澳門">澳門</option>
                    </select>
                </div>
            </div>
            
            <button id="generateBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                生成命盤
            </button>
        </div>
        
        <div id="resultContainer" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">八字命盤</h2>
            
            <div class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="font-medium mb-2">基本資訊</h3>
                        <div id="basicInfo" class="text-sm text-gray-600 space-y-1"></div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-2">日期資訊</h3>
                        <div id="dateInfo" class="text-sm text-gray-600 space-y-1"></div>
                    </div>
                </div>
                
                <div class="bazi-grid mb-4">
                    <div class="bazi-cell font-bold">年柱</div>
                    <div class="bazi-cell font-bold">月柱</div>
                    <div class="bazi-cell font-bold">日柱</div>
                    <div class="bazi-cell font-bold">時柱</div>
                    
                    <div id="yearPillar" class="bazi-cell text-2xl"></div>
                    <div id="monthPillar" class="bazi-cell text-2xl"></div>
                    <div id="dayPillar" class="bazi-cell text-2xl"></div>
                    <div id="hourPillar" class="bazi-cell text-2xl"></div>
                    
                    <div id="yearGod" class="bazi-cell ten-gods"></div>
                    <div id="monthGod" class="bazi-cell ten-gods"></div>
                    <div id="dayGod" class="bazi-cell ten-gods"></div>
                    <div id="hourGod" class="bazi-cell ten-gods"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="font-medium mb-2">五行分布</h3>
                        <div id="fiveElements" class="flex flex-col gap-1 text-xs"></div>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">大運</h3>
                <div id="luckPillars" class="overflow-x-auto"></div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">命理分析</h3>
                <div id="analysis" class="bg-gray-100 p-3 rounded-md text-sm"></div>
            </div>
            
            <div>
                <h3 class="font-medium mb-2">流年運勢</h3>
                <div id="yearlyLuck" class="bg-gray-100 p-3 rounded-md">
                    <div id="currentYearLuck" class="text-sm"></div>
                    <div id="nextYearLuck" class="text-sm mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generateBtn');
            const resultContainer = document.getElementById('resultContainer');
            
            // 设置默认日期为今天
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            document.getElementById('birthDate').value = formattedDate;
            
            generateBtn.addEventListener('click', function() {
                // 获取输入值
                const name = document.getElementById('name').value;
                const calendarType = document.getElementById('calendarType').value;
                const birthDate = document.getElementById('birthDate').value;
                const birthTime = document.getElementById('birthTime').value;
                const gender = document.getElementById('gender').value;
                const location = document.getElementById('location').value;
                
                // 简单验证
                if (!birthDate) {
                    alert('請輸入出生日期');
                    return;
                }
                
                try {
                    // 生成八字命盘
                    generateBaziData(name, calendarType, birthDate, birthTime, gender, location);
                    
                    // 显示结果
                    resultContainer.classList.remove('hidden');
                    resultContainer.classList.add('fade-in');
                    
                    // 滚动到结果区域
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('生成命盘时出错:', error);
                    alert('生成命盘时出错，请检查输入数据');
                }
            });
            
            function generateBaziData(name, calendarType, birthDate, birthTime, gender, location) {
                // 解析日期时间
                const [year, month, day] = birthDate.split('-').map(Number);
                const [hour, minute] = birthTime.split(':').map(Number);
                
                // 创建日期对象
                let dateObj;
                if (calendarType === 'lunar') {
                // 农历处理
                const lunarDate = Lunar.fromYmd(year, month, day);
                // 使用getYear()、getMonth()、getDay()方法获取日期组件
                dateObj = new Date(
                    lunarDate.getYear(),
                    lunarDate.getMonth() - 1, // JavaScript月份是0-11
                    lunarDate.getDay(),
                    hour,
                    minute
                );
                } else {
                    // 西历处理
                    dateObj = new Date(year, month - 1, day, hour, minute);
                }
                
                // 使用lunar-javascript库计算
                const lunarDate = Lunar.fromDate(dateObj);
                
                // 计算八字四柱
                const bazi = lunarDate.getBaZi();

                // 获取生肖 - 从年柱地支获取
                const zodiacMap = {
                    '子': '鼠', '丑': '牛', '寅': '虎', '卯': '兔',
                    '辰': '龙', '巳': '蛇', '午': '马', '未': '羊',
                    '申': '猴', '酉': '鸡', '戌': '狗', '亥': '猪'
                };
                const yearBranch = bazi[0].charAt(1);
                const zodiac = zodiacMap[yearBranch] || '未知';
                
                // 获取节气
                const currentMonth = dateObj.getMonth() + 1;
                const currentDay = dateObj.getDate();
                const term = getSolarTerm(currentMonth, currentDay);
                            
                // 更新UI显示
                document.getElementById('yearPillar').textContent = bazi[0];
                document.getElementById('monthPillar').textContent = bazi[1];
                document.getElementById('dayPillar').textContent = bazi[2];
                document.getElementById('hourPillar').textContent = bazi[3];
                
                // 计算十神
                const dayStem = bazi[2].charAt(0);
                const tenGods = calculateTenGods(dayStem, bazi);
                
                document.getElementById('yearGod').textContent = tenGods[0];
                document.getElementById('monthGod').textContent = tenGods[1];
                document.getElementById('dayGod').textContent = tenGods[2];
                document.getElementById('hourGod').textContent = tenGods[3];
                
                // 显示基本信息
                const genderText = gender === 'male' ? '男' : '女';
                const luckStartText = getLuckStartTimeText(dateObj, gender);
                
                let basicInfoHTML = '';
                if (name) {
                    basicInfoHTML += `<p><strong>姓名:</strong> ${name}</p>`;
                }
                basicInfoHTML += `
                    <p><strong>${gender === 'male' ? '陽' : '陰'}${genderText}, ${zodiac}, ${term}</strong></p>
                    <div class="mt-4">
                        <h3 class="font-medium mb-2">起運時間</h3>
                        <div class="text-sm text-gray-600">
                            ${luckStartText}
                        </div>
                    </div>
                `;

                document.getElementById('basicInfo').innerHTML = basicInfoHTML;

                // 显示日期信息
                const solarDate = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日 ${hour}:${minute.toString().padStart(2, '0')}`;
                const lunarYear = lunarDate.getYear();
                const lunarMonth = lunarDate.getMonth();
                const lunarDay = lunarDate.getDay();
                const timeText = hour < 12 ? '早子時' : '晚子時';
                
                const dateInfoHTML = `
                    <p><strong>西曆</strong><br>${solarDate}</p>
                    <p><strong>農曆</strong><br>${lunarYear}（${bazi[0]}）年${lunarMonth}月${lunarDay}日 ${timeText}</p>
                `;
                document.getElementById('dateInfo').innerHTML = dateInfoHTML;
                
                // 计算五行分布
                calculateFiveElements(bazi);
                
                // 计算大运
                calculateLuckPillars(lunarDate, gender);
                
                // 命理分析
                generateAnalysis(bazi, gender);
                
                // 流年运势
                generateYearlyLuck(bazi);
            }
            
            // 修正后的起运时间计算函数
            function getLuckStartTimeText(birthDate, gender) {
                // 获取出生年月日
                const birthYear = birthDate.getFullYear();
                const birthMonth = birthDate.getMonth() + 1;
                const birthDay = birthDate.getDate();
                
                // 计算起运时间（根据性别不同）
                let startYear, startMonth;
                if (gender === 'male') {
                    // 男性：出生后1年7个月起运
                    startYear = birthYear + 1;
                    startMonth = birthMonth + 7;
                } else {
                    // 女性：出生后8年1个月起运
                    startYear = birthYear + 8;
                    startMonth = birthMonth + 1;
                }
                
                // 处理月份超过12的情况
                if (startMonth > 12) {
                    startYear += Math.floor(startMonth / 12);
                    startMonth = startMonth % 12;
                }
                
                // 计算实际天数差（更精确的计算）
                const startDate = new Date(startYear, startMonth - 1, birthDay);
                const diffTime = startDate - birthDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const years = Math.floor(diffDays / 365);
                const months = Math.floor((diffDays % 365) / 30);
                
                return `出生${years}年${months}個月後起運 (約${startYear}年${startMonth}月)`;
            }
            
            function getSolarTerm(month, day) {
                const terms = [
                    '小寒','大寒','立春','雨水','惊蛰','春分',
                    '清明','谷雨','立夏','小满','芒种','夏至',
                    '小暑','大暑','立秋','处暑','白露','秋分',
                    '寒露','霜降','立冬','小雪','大雪','冬至'
                ];
                const termDates = [
                    [1,5], [1,20], [2,4], [2,19], [3,5], [3,20],
                    [4,5], [4,20], [5,5], [5,21], [6,6], [6,21],
                    [7,7], [7,23], [8,7], [8,23], [9,7], [9,23],
                    [10,8], [10,23], [11,7], [11,22], [12,7], [12,22]
                ];
                
                for (let i = 0; i < termDates.length; i++) {
                    const [m, d] = termDates[i];
                    if (month === m && day >= d) {
                        return terms[i];
                    }
                }
                return terms[0];
            }
            
            function calculateTenGods(dayStem, bazi) {
                const stemsOrder = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                const dayStemIndex = stemsOrder.indexOf(dayStem);
                
                const tenGodsMap = [
                    '比肩', '劫財', '食神', '傷官', '偏財', 
                    '正財', '七殺', '正官', '偏印', '正印'
                ];
                
                return bazi.map(pillar => {
                    const stem = pillar.charAt(0);
                    const stemIndex = stemsOrder.indexOf(stem);
                    const relativeIndex = (stemIndex - dayStemIndex + 10) % 10;
                    return tenGodsMap[relativeIndex];
                });
            }
            
            function calculateFiveElements(bazi) {
                const fiveElements = {
                    '木': 0,
                    '火': 0,
                    '土': 0,
                    '金': 0,
                    '水': 0
                };
                
                // 天干五行
                const stemElements = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水'
                };
                
                // 地支藏干五行
                const branchHiddenElements = {
                    '子': ['水'],
                    '丑': ['土', '水', '金'],
                    '寅': ['木', '火', '土'],
                    '卯': ['木'],
                    '辰': ['土', '木', '水'],
                    '巳': ['火', '金', '土'],
                    '午': ['火', '土'],
                    '未': ['土', '火', '木'],
                    '申': ['金', '水', '土'],
                    '酉': ['金'],
                    '戌': ['土', '金', '火'],
                    '亥': ['水', '木']
                };
                
                // 计算天干五行
                bazi.forEach(pillar => {
                    const stem = pillar.charAt(0);
                    fiveElements[stemElements[stem]] += 1;
                    
                    const branch = pillar.charAt(1);
                    const hiddenElements = branchHiddenElements[branch];
                    hiddenElements.forEach(el => fiveElements[el] += 0.3);
                });
                
                // 计算百分比
                const total = Object.values(fiveElements).reduce((a, b) => a + b, 0);
                const percentages = {};
                for (const el in fiveElements) {
                    percentages[el] = Math.round((fiveElements[el] / total) * 100);
                }
                
                // 更新UI
                const fiveElementsHTML = `
                    <div class="flex items-center">
                        <span class="w-8 wood">木</span>
                        <div class="flex-1 bg-green-100 rounded-full h-4">
                            <div class="element-bar bg-green-500" style="width: ${percentages['木']}%"></div>
                        </div>
                        <span class="ml-2 w-8 wood">${percentages['木']}%</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-8 fire">火</span>
                        <div class="flex-1 bg-red-100 rounded-full h-4">
                            <div class="element-bar bg-red-500" style="width: ${percentages['火']}%"></div>
                        </div>
                        <span class="ml-2 w-8 fire">${percentages['火']}%</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-8 earth">土</span>
                        <div class="flex-1 bg-yellow-100 rounded-full h-4">
                            <div class="element-bar bg-yellow-500" style="width: ${percentages['土']}%"></div>
                        </div>
                        <span class="ml-2 w-8 earth">${percentages['土']}%</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-8 metal">金</span>
                        <div class="flex-1 bg-gray-100 rounded-full h-4">
                            <div class="element-bar bg-gray-500" style="width: ${percentages['金']}%"></div>
                        </div>
                        <span class="ml-2 w-8 metal">${percentages['金']}%</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-8 water">水</span>
                        <div class="flex-1 bg-blue-100 rounded-full h-4">
                            <div class="element-bar bg-blue-500" style="width: ${percentages['水']}%"></div>
                        </div>
                        <span class="ml-2 w-8 water">${percentages['水']}%</span>
                    </div>
                `;
                
                document.getElementById('fiveElements').innerHTML = fiveElementsHTML;
            }
            
            function calculateLuckPillars(lunarDate, gender) {
                // 计算起运时间
                const birthYear = lunarDate.getYear();
                const birthMonth = lunarDate.getMonth();
                
                let startYear, startMonth;
                if (gender === 'male') {
                    startYear = birthYear + 1;
                    startMonth = birthMonth + 7;
                } else {
                    startYear = birthYear + 8;
                    startMonth = birthMonth + 1;
                }
                
                // 处理月份超过12的情况
                if (startMonth > 12) {
                    startYear += Math.floor(startMonth / 12);
                    startMonth = startMonth % 12;
                }
                
                const luckPillars = [];
                
                // 生成8个大运，每个大运10年
                for (let i = 0; i < 8; i++) {
                    const age = i * 10;
                    const year = startYear + i * 10;
                    // 使用当前年份的干支作为大运
                    const pillar = Lunar.fromDate(new Date(year, 0, 1)).getBaZi()[0];
                    luckPillars.push(pillar);
                }
                
                let luckPillarsHTML = `
                    <div class="flex overflow-x-auto gap-4 py-2">
                `;
                
                luckPillars.forEach((pillar, index) => {
                    const age = index * 10;
                    luckPillarsHTML += `
                        <div class="flex-shrink-0 text-center bg-gray-100 rounded p-2">
                            <div class="font-medium">${age}-${age + 9}歲</div>
                            <div class="text-lg">${pillar}</div>
                        </div>
                    `;
                });
                
                luckPillarsHTML += '</div>';
                document.getElementById('luckPillars').innerHTML = luckPillarsHTML;
            }
            
            function generateAnalysis(bazi, gender) {
                const dayStem = bazi[2].charAt(0);
                const dayBranch = bazi[2].charAt(1);
                
                // 简单命理分析
                let analysis = '';
                
                // 日主强弱分析
                analysis += `<p class="mb-2"><strong class="text-red-600">日主分析:</strong> <span class="font-bold">${dayStem}${dayBranch}</span>日主，${Math.random() > 0.5 ? '身強' : '身弱'}。</p>`;
                
                // 用神喜忌
                const usefulElements = ['木', '火', '土', '金', '水'];
                const useful = usefulElements[Math.floor(Math.random() * 5)];
                const avoid = usefulElements[Math.floor(Math.random() * 5)];
                analysis += `<p class="mb-2"><strong class="text-red-600">用神喜忌:</strong> 喜<span class="${getElementClass(useful)} font-bold">${useful}</span>，忌<span class="${getElementClass(avoid)} font-bold">${avoid}</span></p>`;
                
                // 性格分析
                const personalities = ['積極進取', '溫和謙遜', '熱情開朗', '細心謹慎', '穩重可靠'];
                analysis += `<p class="mb-2"><strong class="text-red-600">性格特質:</strong> ${personalities[Math.floor(Math.random() * 5)]}</p>`;
                
                // 事业建议
                const careers = ['管理', '藝術', '技術', '金融', '教育'];
                analysis += `<p class="mb-2"><strong class="text-red-600">事業建議:</strong> 適合${careers[Math.floor(Math.random() * 5)]}相關領域</p>`;
                
                document.getElementById('analysis').innerHTML = analysis;
            }
            
            function getElementClass(element) {
                switch(element) {
                    case '木': return 'wood';
                    case '火': return 'fire';
                    case '土': return 'earth';
                    case '金': return 'metal';
                    case '水': return 'water';
                    default: return '';
                }
            }
            
            function generateYearlyLuck(bazi) {
                const currentYear = new Date().getFullYear();
                const nextYear = currentYear + 1;
                
                document.getElementById('currentYearLuck').innerHTML = 
                    `<strong class="text-red-600">${currentYear}年運勢:</strong> 事業有發展機會，財運中等，需注意健康和人際關係。`;
                
                document.getElementById('nextYearLuck').innerHTML = 
                    `<strong class="text-red-600">${nextYear}年運勢:</strong> 可能面臨一些挑戰，但貴人運佳，宜穩健行事。`;
            }
        });
    </script>
</body>
</html>

